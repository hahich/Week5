<div
  class="
    product-testimonials-section
    section-width-{{ section.settings.section_width }}
    {% if section.settings.remove_default_space %}no-default-space{% endif %}
    {% if section.settings.color_scheme != blank %}color-{{ section.settings.color_scheme }}{% endif %}
  "
  style="padding-top:{{ section.settings.padding_top }}px; padding-bottom:{{ section.settings.padding_bottom }}px;"
>
  {% if section.settings.heading != blank %}
    <h2 class="testimonial-heading heading-size-{{ section.settings.header_size }} align-{{ section.settings.alignment }}">
      {{ section.settings.heading }}
    </h2>
  {% endif %}
  {% if section.settings.description != blank %}
    <div class="testimonial-description align-{{ section.settings.alignment }}">
      {{ section.settings.description }}
    </div>
  {% endif %}

  <!-- Swiper Container -->
  <div
    class="testimonial-carousel swiper"
    data-items-per-row="{{ section.settings.items_per_row }}"
    data-mobile-items-per-row="{{ section.settings.mobile_items_per_row }}"
    data-autoplay="{{ section.settings.auto_change_slides }}"
    data-autoplay-speed="{{ section.settings.change_slides_every }}"
    data-show-next-back="{{ section.settings.show_next_back }}"
    data-pagination="{{ section.settings.pagination }}"
    data-reveal-next-slide="{{ section.settings.reveal_next_slide }}"
    data-column-gap="{{ section.settings.column_gap }}"
    data-infinite="{{ section.settings.infinite_slider }}"
  >
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        <div
          class="swiper-slide testimonial-item image-{{ section.settings.image_position }} {% if section.settings.framed %}framed{% endif %}"
        >
          {% if section.settings.show_image %}
            <div class="testimonial-image" style="width: {{ section.settings.image_width }}%;">
              {% if block.settings.author_image != blank %}
                <img
                  src="{{ block.settings.author_image | img_url: '300x300' }}"
                  alt="{{ block.settings.author_name }}"
                  width="150"
                  height="150"
                >
              {% else %}
                <div class="testimonial-image-placeholder"></div>
              {% endif %}
            </div>
          {% endif %}
          <div class="testimonial-content">
            <div class="testimonial-rating">
              {% for i in (1..block.settings.star_rating) %}
                <span class="star">
                  <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.96853 3.78143C10.0011 3.88335 10.0043 3.98868 9.9783 4.0974C9.95226 4.20612 9.89692 4.29785 9.81228 4.37259L7.63455 6.37033L8.27908 9.32616C8.29861 9.43488 8.28885 9.5402 8.24978 9.64213C8.21723 9.74405 8.15864 9.82899 8.074 9.89694C7.98286 9.96489 7.8852 9.99887 7.78103 9.99887C7.67687 10.0057 7.57921 9.98188 7.48806 9.92752L4.99783 8.36806L2.5076 9.92752C2.46853 9.94791 2.42296 9.96489 2.37088 9.97848C2.3253 9.99207 2.27973 9.99887 2.23416 9.99887C2.18207 9.99887 2.12674 9.98868 2.06814 9.96829C2.01606 9.9547 1.96723 9.93092 1.92166 9.89694C1.83702 9.82899 1.77517 9.74405 1.73611 9.64213C1.70356 9.5402 1.69705 9.43488 1.71658 9.32616L2.36111 6.37033L0.183377 4.37259C0.0987413 4.29785 0.0434028 4.20612 0.0173611 4.0974C-0.00868056 3.98868 -0.00542535 3.88335 0.0271267 3.78143C0.0596788 3.67271 0.115017 3.58437 0.193142 3.51642C0.277778 3.44847 0.372179 3.4077 0.476345 3.39411L3.36697 3.12911L4.50955 0.336353C4.54861 0.234428 4.61372 0.152888 4.70486 0.0917327C4.79601 0.0305776 4.89366 0 4.99783 0C5.102 0 5.19965 0.0305776 5.2908 0.0917327C5.38194 0.152888 5.44705 0.234428 5.48611 0.336353L6.62869 3.12911L9.51931 3.39411C9.62348 3.4077 9.71463 3.44847 9.79275 3.51642C9.87739 3.58437 9.93598 3.67271 9.96853 3.78143Z" fill="{{ section.settings.rate_color }}"/>
                  </svg>
                </span>
              {% endfor %}
              {% for i in (1..5) %}
                {% if i > block.settings.star_rating %}
                  <span class="star inactive">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9.96853 3.78143C10.0011 3.88335 10.0043 3.98868 9.9783 4.0974C9.95226 4.20612 9.89692 4.29785 9.81228 4.37259L7.63455 6.37033L8.27908 9.32616C8.29861 9.43488 8.28885 9.5402 8.24978 9.64213C8.21723 9.74405 8.15864 9.82899 8.074 9.89694C7.98286 9.96489 7.8852 9.99887 7.78103 9.99887C7.67687 10.0057 7.57921 9.98188 7.48806 9.92752L4.99783 8.36806L2.5076 9.92752C2.46853 9.94791 2.42296 9.96489 2.37088 9.97848C2.3253 9.99207 2.27973 9.99887 2.23416 9.99887C2.18207 9.99887 2.12674 9.98868 2.06814 9.96829C2.01606 9.9547 1.96723 9.93092 1.92166 9.89694C1.83702 9.82899 1.77517 9.74405 1.73611 9.64213C1.70356 9.5402 1.69705 9.43488 1.71658 9.32616L2.36111 6.37033L0.183377 4.37259C0.0987413 4.29785 0.0434028 4.20612 0.0173611 4.0974C-0.00868056 3.98868 -0.00542535 3.88335 0.0271267 3.78143C0.0596788 3.67271 0.115017 3.58437 0.193142 3.51642C0.277778 3.44847 0.372179 3.4077 0.476345 3.39411L3.36697 3.12911L4.50955 0.336353C4.54861 0.234428 4.61372 0.152888 4.70486 0.0917327C4.79601 0.0305776 4.89366 0 4.99783 0C5.102 0 5.19965 0.0305776 5.2908 0.0917327C5.38194 0.152888 5.44705 0.234428 5.48611 0.336353L6.62869 3.12911L9.51931 3.39411C9.62348 3.4077 9.71463 3.44847 9.79275 3.51642C9.87739 3.58437 9.93598 3.67271 9.96853 3.78143Z" fill="#ccc"/>
                    </svg>
                  </span>
                {% endif %}
              {% endfor %}
            </div>
            <div class="testimonial-author">
              <strong>{{ block.settings.author_name }}</strong>
              {% if section.settings.show_verified_buyer %}
                <span class="verified-buyer">âœ” Verified Buyer</span>
              {% endif %}
            </div>
            <div class="testimonial-quote">
              {{ block.settings.quote }}
            </div>
            <div class="testimonial-product">
              {% if block.settings.product != blank %}
                {% assign product = all_products[block.settings.product] %}
                <a href="{{ product.url }}" class="testimonial-product-link" target="_blank">
                  <div class="testimonial-product-image">
                    <img
                      src="{{ product.featured_image | img_url: '300x300' }}"
                      alt="{{ product.title }}"
                      width="100"
                      height="100"
                    >
                  </div>
                  <div class="testimonial-product-info">
                    <div class="testimonial-product-title">
                      <a href="{{ product.url }}" class="testimonial-product-link" target="_blank">
                        {{ product.title }}
                      </a>
                    </div>
                    <div class="testimonial-product-price">{{ product.price | money }}</div>
                  </div>
              {% else %}
                <div class="testimonial-product-image testimonial-image-placeholder"></div>
                <div class="testimonial-product-info">
                  <div class="testimonial-product-title">Example product title</div>
                  <div class="testimonial-product-price">$19.99</div>
                  <div class="testimonial-product-fake-content">
                    This is a fake product description for demo purposes.
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% if section.settings.show_next_back %}
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    {% endif %}
    {% if section.settings.pagination != 'disable' %}
      <div class="swiper-pagination"></div>
    {% endif %}
  </div>

  <script>
    (function () {
      function initTestimonialCarousel() {
        var el = document.querySelector('.product-testimonials-section .testimonial-carousel.swiper');
        if (!el) return;
        if (el.swiper) {
          el.swiper.destroy(true, true);
        }
        var itemsPerRow = parseInt(el.getAttribute('data-items-per-row')) || 2;
        var mobileItemsPerRow = parseInt(el.getAttribute('data-mobile-items-per-row')) || 1;
        var gap = parseInt(el.getAttribute('data-column-gap')) || 24;
        var autoplay = el.getAttribute('data-autoplay') === 'true';
        var autoplaySpeed = parseInt(el.getAttribute('data-autoplay-speed')) * 1000 || 4000;
        var showNextBack = el.getAttribute('data-show-next-back') === 'true';
        var paginationType = el.getAttribute('data-pagination');
        var infinite = el.getAttribute('data-infinite') === 'true';
        var revealNext = el.getAttribute('data-reveal-next-slide') === 'true';

        el.style.setProperty('--items-per-row', itemsPerRow);
        el.style.setProperty('--mobile-items-per-row', mobileItemsPerRow);
        el.style.setProperty('--column-gap', gap + 'px');

        if (typeof Swiper === 'undefined') {
          console.warn(
            'SwiperJS library is required for the testimonials carousel. Please include SwiperJS in your theme assets.'
          );
          return;
        }

        var swiper = new Swiper(el, {
          slidesPerView: itemsPerRow,
          spaceBetween: gap,
          loop: infinite,
          navigation: showNextBack
            ? {
                nextEl: el.querySelector('.swiper-button-next'),
                prevEl: el.querySelector('.swiper-button-prev'),
              }
            : false,
          pagination:
            paginationType && paginationType !== 'disable'
              ? {
                  el: el.querySelector('.swiper-pagination'),
                  clickable: true,
                  type: paginationType === 'progress' ? 'progressbar' : 'bullets',
                }
              : false,
          autoplay: autoplay
            ? {
                delay: autoplaySpeed,
                disableOnInteraction: false,
              }
            : false,
          breakpoints: {
            0: { slidesPerView: mobileItemsPerRow },
            769: { slidesPerView: itemsPerRow },
          },
          centeredSlides: revealNext,
          slidesPerGroup: 1,
          watchOverflow: true,
        });

        el.swiper = swiper;
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTestimonialCarousel);
      } else {
        initTestimonialCarousel();
      }

      if (typeof window.Shopify !== 'undefined' && window.Shopify.designMode) {
        document.addEventListener('shopify:section:load', function (event) {
          if (event.target.classList.contains('product-testimonials-section')) {
            setTimeout(initTestimonialCarousel, 100);
          }
        });

        document.addEventListener('shopify:block:select', function (event) {
          if (event.target.closest('.product-testimonials-section')) {
            setTimeout(initTestimonialCarousel, 100);
          }
        });

        document.addEventListener('shopify:section:reorder', function (event) {
          if (event.target.classList.contains('product-testimonials-section')) {
            setTimeout(initTestimonialCarousel, 100);
          }
        });
      }
    })();
  </script>
</div>

<style>
  .product-testimonials-section {
    margin: 0 auto;
    padding: 0 20px;
  }
  .section-width-default {
    max-width: 800px;
  }
  .section-width-fluid {
    max-width: 1410px;
  }
  .section-width-stretch {
    width: calc(100% - 40px);
  }
  .section-width-full {
    width: 100vw;
  }
  .no-default-space {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }
  .align-left {
    text-align: left;
  }
  .align-center {
    text-align: center;
  }
  .align-right {
    text-align: right;
  }
  .heading-size-small {
    font-size: 1.5rem;
  }
  .heading-size-medium {
    font-size: 2rem;
  }
  .heading-size-large {
    font-size: 2.5rem;
  }

  .testimonial-carousel {
    display: grid;
    grid-template-columns: repeat(var(--items-per-row, 2), 1fr);
    gap: var(--column-gap, 24px);
  }
  @media (max-width: 768px) {
    .testimonial-carousel {
      grid-template-columns: repeat(var(--mobile-items-per-row, 1), 1fr);
    }
  }

  .testimonial-item {
    background: var(--color-background, #fff);
    border-radius: 6px;
    border: 1px solid rgba(var(--color-foreground), 0.08);
    display: flex;
    flex-direction: row;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
    width: 100%;
    height: auto;
    box-sizing: border-box;
  }
  .framed {
    border: 2px solid var(--color-accent, #eee);
  }
  .image-left.testimonial-item {
    flex-direction: row;
  }
  .image-right.testimonial-item {
    flex-direction: row-reverse;
  }
  .image-top.testimonial-item {
    flex-direction: column;
  }
  .image-bottom.testimonial-item {
    flex-direction: column-reverse;
  }
  .image-top.testimonial-item > .testimonial-image,
  .image-bottom.testimonial-item > .testimonial-image {
    width: 100% !important;
    max-width: none !important;
    min-width: auto !important;
  }
  .testimonial-image {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px 0 0 6px;
    overflow: hidden;
    background: #eee;
    padding: 0;
  }
  .testimonial-image img {
    display: block;
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .testimonial-image-placeholder {
    width: 60px;
    height: 60px;
    background: #ddd;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .testimonial-image-placeholder svg {
    opacity: 0.6;
  }

  .testimonial-content {
    flex: 1;
    padding: 24px;
    display: flex;
    flex-direction: column;
    min-width: 0;
    overflow: hidden;
  }
  .testimonial-rating {
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  .star {
    color: inherit;
  }
  .star.inactive {
    color: #ccc;
  }
  .verified-buyer {
    color: #888;
    font-size: 0.95em;
    margin-left: 8px;
    font-style: italic;
  }
  .testimonial-author {
    flex-shrink: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .testimonial-quote {
    color: #333;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    line-height: 1.5;
    min-width: 0;
  }
  .testimonial-product {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
    flex-shrink: 0;
  }
  .testimonial-product-image {
    flex-shrink: 0;
  }
  .testimonial-product-image img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
  }
  .testimonial-product-info {
    min-width: 0;
    flex: 1;
  }
  .testimonial-product-title {
    font-weight: 500;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .testimonial-product-title a {
    color: inherit;
    text-decoration: none;
  }
  .testimonial-product-price {
    font-weight: bold;
  }

  .shopify-editor .testimonial-carousel {
    transition: all 0.3s ease;
  }

  .shopify-editor .testimonial-item {
    transition: all 0.3s ease;
  }
</style>

{% schema %}
{
  "name": "Product Testimonials",
  "settings": [
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "fluid", "label": "Fluid container" },
        { "value": "stretch", "label": "Stretch width" },
        { "value": "full", "label": "Full width" }
      ],
      "default": "default"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme"
    },
    {
      "type": "header",
      "content": "Section header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What our customers say"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_size",
      "label": "Heading size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Testimonial settings"
    },
    {
      "type": "checkbox",
      "id": "show_verified_buyer",
      "label": "Show verified buyer",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show image",
      "default": true
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "top", "label": "Top" },
        { "value": "right", "label": "Right" },
        { "value": "bottom", "label": "Bottom" }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "image_width",
      "label": "Image width",
      "min": 20,
      "max": 50,
      "step": 1,
      "unit": "%",
      "default": 30
    },
    {
      "type": "checkbox",
      "id": "framed",
      "label": "Framed",
      "default": false
    },
    {
      "type": "color",
      "id": "rate_color",
      "label": "Rate color",
      "default": "#FFA500"
    },
    {
      "type": "range",
      "id": "items_per_row",
      "label": "Items per row",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "column_gap",
      "label": "Column gap (px)",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 24
    },
    {
      "type": "checkbox",
      "id": "show_next_back",
      "label": "Show next/back",
      "default": true
    },
    {
      "type": "select",
      "id": "pagination",
      "label": "Pagination",
      "options": [
        { "value": "disable", "label": "Disable" },
        { "value": "dots", "label": "Show dots" },
        { "value": "dots_mobile", "label": "Show dots on mobile" },
        { "value": "progress", "label": "Show progress bar" }
      ],
      "default": "dots"
    },
    {
      "type": "checkbox",
      "id": "infinite_slider",
      "label": "Infinite slider",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "auto_change_slides",
      "label": "Auto change slides",
      "default": false
    },
    {
      "type": "range",
      "id": "change_slides_every",
      "label": "Change slides every (seconds)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "reveal_next_slide",
      "label": "Reveal next slide",
      "default": false
    },
    {
      "type": "header",
      "content": "Mobile settings"
    },
    {
      "type": "range",
      "id": "mobile_items_per_row",
      "label": "Items per row (mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 1
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 32
    },
    {
      "type": "checkbox",
      "id": "remove_default_space",
      "label": "Remove default space between sections",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author's image"
        },
        {
          "type": "range",
          "id": "star_rating",
          "label": "Star rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "richtext",
          "id": "quote",
          "label": "Quote"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Author's name",
          "default": "Author's name"
        }
      ]
    }
  ],
  "max_blocks": 10,
  "presets": [
    {
      "name": "Product Testimonials",
      "category": "Text",
      "blocks": [{ "type": "testimonial" }, { "type": "testimonial" }]
    }
  ]
}
{% endschema %}
