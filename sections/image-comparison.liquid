{% assign section_color_scheme = section.settings.color_scheme | default: settings.color_scheme %}
{% assign page_width = section.settings.page_width %}
{% if page_width == blank or page_width == 'default' %}
  {% assign page_width = settings.page_width | default: 'default' %}
{% endif %}

{% comment %} Calculate section width based on settings {% endcomment %}
{% assign calculated_width = '1410px' %}
{% if page_width == 'fluid' %}
  {% assign calculated_width = settings.page_width | default: '1200px' | append: 'px' %}
{% elsif page_width == 'stretch' %}
  {% assign stretch_width = settings.page_width | default: '1200px' | append: 'px' %}
  {% assign calculated_width = stretch_width | minus: 40 | append: 'px' %}
{% elsif page_width == 'full' %}
  {% assign calculated_width = '100%' %}
{% endif %}
{% assign header_size = section.settings.header_size %}
{% assign alignment = section.settings.alignment %}
{% assign before_image = section.settings.before_image %}
{% assign after_image = section.settings.after_image %}
{% assign width = section.settings.width %}
{% assign position = section.settings.position %}
{% assign show_text = section.settings.show_text %}
{% assign image_ratio = section.settings.image_ratio %}
{% assign custom_ratio = section.settings.custom_ratio %}
{% assign padding_top = section.settings.padding_top %}
{% assign padding_bottom = section.settings.padding_bottom %}
{% assign remove_space = section.settings.remove_space %}

{% capture section_classes %}
  image-comparison-section
  section-width-{{ page_width }}
  color-{{ section_color_scheme }}
  {% if remove_space %}no-section-space{% endif %}
{% endcapture %}
<div class="{{ section_classes | strip_newlines }}" style="max-width: {{ calculated_width }}; margin: 0 auto;">
  <div class="image-comparision-header" style="text-align: {{ alignment }};">
    <h2>{{ section.settings.heading_text }}</h2>
    <p>{{ section.settings.description_text }}</p>
  </div>
  <div
    class="
      image-comparison-flex
      {% if width == '100' %}
        is-full-width{% if position == 'right' %} position-right{% endif %}
      {% else %}
        {% if position == 'left' %} flex-row{% else %} flex-row-reverse{% endif %}
      {% endif %}
    "
  >
    <div
      class="image-comparison-left{% if width == '100' %} is-full-width{% endif %}"
      style="width: {{ width }}%;"
    >
      <div
        class="image-comparison-slider"
        id="image-comparison-{{ section.id }}"
        style="
          {% if image_ratio == 'square' %}aspect-ratio: 1/1;{% endif %}
          {% if image_ratio == 'portrait' %}aspect-ratio: 3/4;{% endif %}
          {% if image_ratio == 'landscape' %}aspect-ratio: 4/3;{% endif %}
          {% if image_ratio == 'custom' and custom_ratio != blank %}aspect-ratio: {{ custom_ratio | replace: ':', '/' }};{% endif %}
        "
      >
        <img
          class="before-image"
          src="{{ before_image | image_url }}"
          alt="Before"
          loading="lazy"
          width="800"
          height="600"
          style="z-index:1;"
        >
        <img
          class="after-image"
          src="{{ after_image | image_url }}"
          alt="After"
          loading="lazy"
          width="800"
          height="600"
          style="z-index:2; position:absolute; top:0; left:0; height:100%; width:100%;"
        >
        {% if show_text %}
          <span class="image-comparison-label before">BEFORE</span>
          <span class="image-comparison-label after">AFTER</span>
        {% endif %}
        <div class="slider-bar">
          <button class="slider-bar-button__pull" type="button">
            <svg width="10" height="24" viewBox="0 0 10 24" fill="none">
              <rect width="2" height="24" rx="1" fill="currentColor"></rect>
              <rect x="4" width="2" height="24" rx="1" fill="currentColor"></rect>
              <rect x="8" width="2" height="24" rx="1" fill="currentColor"></rect>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div
      class="image-content-wrapper{% if width == '100' %} is-full-width{% endif %}"
      style="{% if width != '100' %}width: calc(100% - {{ width }}%);{% endif %}"
    >
             <div
         class="image-comparison-top"
       >
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'heading' %}
              <div class="ip-content-block">
                <h2
                  class="image-comparison-heading"
                  style="
                    font-size: {{ block.settings.font_size }}px; margin-top: 0;
                    font-weight: {{ block.settings.font_weight }};
                    margin-bottom: {{ block.settings.header_spacing_bottom }}px;
                    {% if block.settings.header_transform %}text-transform: uppercase;{% endif %}
                  "
                >
                  {{ block.settings.heading_text }}
                </h2>
              </div>
            {% when 'description' %}
              <div class="ip-content-block">
                <div
                  class="image-comparison-description"
                  style="
                    font-size: {{ block.settings.font_size }}px;
                    font-weight: {{ block.settings.font_weight }};
                    margin-bottom: {{ block.settings.spacing_bottom }}px;
                  "
                >
                  {{ block.settings.description_text }}
                </div>
              </div>
            {% when 'subheading' %}
              <div class="ip-content-block">
                <p
                  class="image-comparison-subheading"
                  style="
                    font-size: {{ block.settings.font_size }}px;
                    font-weight: {{ block.settings.font_weight }};
                    {% if block.settings.uppercase %}text-transform: uppercase;{% endif %}
                    margin-bottom: {{ block.settings.spacing_bottom }}px;
                  "
                >
                  {{ block.settings.subheading_text }}
                </p>
              </div>
            {% when 'button' %}
              <div class="ip-content-block">
                <a
                  href="{{ block.settings.button_url }}"
                  class="image-comparison-btn__{{ block.settings.button_type }}"
                  style="
                    {% if block.settings.button_type == 'primary' %}
                      background: {{ block.settings.button_color }};
                      color: {{ block.settings.button_text_color }};
                    {% endif %}
                    {% if block.settings.button_type == 'outline' %}
                      background: #fff;
                      color: #111;
                    {% endif %}
                    {% if block.settings.button_type == 'link' %}
                      color: #111;
                    {% endif %}
                    margin-bottom: {{ block.settings.spacing_bottom }}px;
                  "
                >
                  {{ block.settings.button_label }}
                </a>
              </div>
                         {% when 'product' %}
               <div class="ip-content-block product-block">
                <div class="image-comparision-wrapper" style="margin-bottom: {{ block.settings.spacing_bottom }}px;">
                  <img
                    src="{{ block.settings.product.featured_image | image_url }}"
                    alt="{{ block.settings.product.title }}"
                    width="100"
                    height="100"
                    loading="lazy"
                  >
                  <div class="ip-product-info">
                    <a
                      href="{{ block.settings.product.url }}"
                      class="image-comparison-btn__{{ block.settings.button_type }}"
                      style="text-decoration: none; color: inherit;"
                    >
                      {{ block.settings.product.title | default: 'Example prodcut title' }}
                    </a>
                    <p>{{ block.settings.product.price | money | default: '$100.00' }}</p>
                  </div>
                </div>
              </div>
          {% endcase %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
  .section-width-full {
    width: 100%;
  }
  .image-comparison-flex.flex-row {
    flex-direction: row;
  }
  .image-comparison-flex.flex-row-reverse {
    flex-direction: row-reverse;
  }
  .image-comparison-section {
    padding-top: {{ padding_top | default: 32 }}px;
    padding-bottom: {{ padding_bottom | default: 32 }}px;
    {% if page_width == 'stretch' %}
      padding-left: 20px;
      padding-right: 20px;
    {% endif %}
  }
  .image-comparison-flex {
    justify-content: center;
    display: flex;
    align-items: stretch;
    flex-wrap: wrap;
    margin: 0 auto;
    width: 100%;
    min-height: 400px;
  }
  .image-content-wrapper {
    word-wrap: break-word;
    width: calc(100% - {{ width }}%);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0 20px;
  }
  .image-content-wrapper.full-width {
    width: 100%;
    padding: 0;
  }
  .image-comparison-left {
    min-width: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  .image-comparision-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .image-comparison-slider {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 350px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    overflow: hidden;
  }
  .image-comparison-slider .before-image,
  .image-comparison-slider .after-image {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  .image-comparison-slider .after-image {
    width: 50%;
    overflow: hidden;
    z-index: 2;
    clip-path: inset(0 50% 0 0);
  }
  .image-comparison-slider img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .image-comparison-slider .slider-bar {
    position: absolute;
    top: 0; bottom: 0;
    left: 50%;
    width: 3px;
    background: #fff;
    box-shadow: 0 0 8px rgba(0,0,0,0.12);
    z-index: 10;
    cursor: ew-resize;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .slider-bar-button__pull {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 36px;
    height: 48px;
    border: none;
    border-radius: 30px;
    background: #fff;
    box-shadow: 0 2px 12px rgba(0,0,0,0.10);
    border: 1.5px solid #eee;
    z-index: 11;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    pointer-events: auto;
    padding: 0;
  }
  .image-comparison-label {
    position: absolute;
    background: #fff;
    color: #222;
    font-weight: 600;
    font-size: 16px;
    border-radius: 999px;
    padding: 8px 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.10);
    z-index: 20;
    letter-spacing: 1px;
    top: 32px;
  }
  .image-comparison-label.before {
    left: 32px;
  }
  .image-comparison-label.after {
    right: 32px;
    bottom: 32px;
    top: auto;
  }
  @media (max-width: 900px) {
    .image-comparison-left, .image-content-wrapper { min-width: 0; flex: 1 1 100%; }
    .image-comparison-label.before { left: 16px; top: 16px; }
    .image-comparison-label.after { right: 16px; bottom: 16px; }
  }
  .image-comparison-heading {
    margin: 0;
  }
  .image-comparison-description {
    font-size: 1.5rem;
    color: #444;
  }
  .image-comparison-btn__primary {
    display: inline-block;
    background: #111;
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 999px;
    padding: 12px 40px;
    font-size: 1.6rem;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s;
    margin-top: 8px;
  }
  .image-comparison-btn__primary
  .image-comparison-btn:hover {
    background: #222;
  }
  .image-comparison-btn__outline {
    display: inline-block;
    padding: 16px 40px;
    background: #fff;
    color: #111;
    font-weight: 600;
    border: 1px solid #111;
    text-decoration: none;
    border-radius: 30px;
  }
  .image-comparison-btn__link {
    display: inline-block;
    color: #111;
    font-weight: 600;
    border: none;
  }
  .image-comparison-flex.is-full-width {
    flex-direction: column;
  }
  .image-comparison-left.is-full-width {
    order: 2;
  }
  .image-content-wrapper.is-full-width {
    order: 1;
    width: 100%;
  }
  .image-comparison-flex.is-full-width.position-right .image-comparison-left.is-full-width {
    order: 1;
  }
  .image-comparison-flex.is-full-width.position-right .image-content-wrapper.is-full-width {
    order: 2;
    width: 100%;
  }
     .image-content-wrapper.is-full-width {
     width: 100% !important;
   }
   .image-comparison-top {
     display: flex;
     flex-direction: column;
     height: 100%;
   }
   .ip-content-block.product-block {
     margin-top: auto;
   }
</style>

<script>
  (function () {
    var slider = document.getElementById('image-comparison-{{ section.id }}');
    if (!slider) return;
    var bar = slider.querySelector('.slider-bar');
    var button = slider.querySelector('.slider-bar-button__pull');
    var beforeImg = slider.querySelector('.before-image');
    var afterImg = slider.querySelector('.after-image');
    var dragging = false;
    var container = slider;

    function setPosition(percent) {
      percent = Math.max(0, Math.min(100, percent));
      bar.style.left = percent + '%';
      button.style.left = '50%';
      button.style.top = '50%';
      button.style.transform = 'translate(-50%, -50%)';
      afterImg.style.clipPath = 'inset(0 0 0 ' + percent + '%)';
    }

    function getPercent(x) {
      var rect = container.getBoundingClientRect();
      return ((x - rect.left) / rect.width) * 100;
    }

    button.addEventListener('mousedown', function (e) {
      dragging = true;
      document.body.style.userSelect = 'none';
    });
    window.addEventListener('mousemove', function (e) {
      if (!dragging) return;
      setPosition(getPercent(e.clientX));
    });
    window.addEventListener('mouseup', function () {
      dragging = false;
      document.body.style.userSelect = '';
    });
    // Touch support
    button.addEventListener('touchstart', function (e) {
      dragging = true;
      document.body.style.userSelect = 'none';
    });
    window.addEventListener('touchmove', function (e) {
      if (!dragging) return;
      setPosition(getPercent(e.touches[0].clientX));
    });
    window.addEventListener('touchend', function () {
      dragging = false;
      document.body.style.userSelect = '';
    });
    // Init
    setPosition(50);
  })();
</script>

{% schema %}
{
  "name": "Image Comparison",
  "settings": [
    {
      "type": "select",
      "id": "page_width",
      "label": "Section width",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "fluid", "label": "Fluid container" },
        { "value": "stretch", "label": "Stretch width" },
        { "value": "full", "label": "Full width" }
      ],
      "default": "default"
    },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme" },
    { "type": "header", "content": "Section header" },
    { "type": "text", "id": "heading_text", "label": "Heading text" },
    { "type": "richtext", "id": "description_text", "label": "Description text" },
    {
      "type": "select",
      "id": "header_size",
      "label": "Header size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    { "type": "header", "content": "Section content" },
    { "type": "image_picker", "id": "before_image", "label": "Before image" },
    { "type": "image_picker", "id": "after_image", "label": "After image" },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "options": [
        { "value": "50", "label": "50%" },
        { "value": "66", "label": "66%" },
        { "value": "75", "label": "75%" },
        { "value": "100", "label": "100%" }
      ],
      "default": "50"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    { "type": "checkbox", "id": "show_text", "label": "Show after before text", "default": true },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image ratio",
      "options": [
        { "value": "adapt", "label": "Adapt to image" },
        { "value": "square", "label": "Square (1:1)" },
        { "value": "portrait", "label": "Portrait (3:4)" },
        { "value": "landscape", "label": "Landscape (4:3)" },
        { "value": "custom", "label": "Custom" }
      ],
      "default": "adapt"
    },
    {
      "type": "text",
      "id": "custom_ratio",
      "label": "Custom ratio (e.g. 16:9)",
      "default": "16:9",
      "info": "Only used if Image ratio is Custom. Please select 'Custom' above to use this value."
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Section padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Section padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 32,
      "unit": "px"
    },
    { "type": "checkbox", "id": "remove_space", "label": "Remove default space between sections", "default": false }
  ],
  "blocks": [
    {
      "type": "heading",
      "name": "Heading",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "heading_text", "label": "Heading Text", "default": "Talk about your brand" },
        { "type": "range", "id": "font_size", "label": "Font Size", "min": 16, "max": 60, "step": 2, "default": 32 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font Weight",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" },
            { "value": "800", "label": "Extra Bold" }
          ],
          "default": "700"
        },
        { "type": "checkbox", "id": "header_transform", "label": "Uppercase", "default": false },
        {
          "type": "range",
          "id": "header_spacing_bottom",
          "label": "Spacing bottom",
          "min": 0,
          "max": 30,
          "step": 1,
          "default": 10,
          "unit": "px"
        }
      ]
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "richtext",
          "id": "description_text",
          "label": "Description Text",
          "default": "<p>Share information about your brand with your customers. Describe a product, make announcements, or welcome customers to your store.</p>"
        },
        { "type": "range", "id": "font_size", "label": "Font Size", "min": 12, "max": 24, "step": 1, "default": 16 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font Weight",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" },
            { "value": "800", "label": "Extra Bold" }
          ],
          "default": "400"
        },
        {
          "type": "range",
          "id": "spacing_bottom",
          "label": "Spacing bottom",
          "min": 0,
          "max": 30,
          "step": 1,
          "default": 10,
          "unit": "px"
        }
      ]
    },
    {
      "type": "subheading",
      "name": "Subheading",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "subheading_text", "label": "Subheading Text", "default": "Subheading text" },
        { "type": "range", "id": "font_size", "label": "Font Size", "min": 12, "max": 36, "step": 2, "default": 14 },
        {
          "type": "select",
          "id": "font_weight",
          "label": "Font Weight",
          "options": [
            { "value": "400", "label": "Normal" },
            { "value": "500", "label": "Medium" },
            { "value": "600", "label": "Semi Bold" },
            { "value": "700", "label": "Bold" },
            { "value": "800", "label": "Extra Bold" }
          ],
          "default": "700"
        },
        { "type": "checkbox", "id": "uppercase", "label": "Uppercase", "default": false },
        {
          "type": "range",
          "id": "spacing_bottom",
          "label": "Spacing bottom",
          "min": 0,
          "max": 30,
          "step": 1,
          "default": 10,
          "unit": "px"
        }
      ]
    },
    {
      "type": "button",
      "name": "Button",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "button_label", "label": "Button Label", "default": "Button label" },
        { "type": "url", "id": "button_url", "label": "Button URL" },
        {
          "type": "select",
          "id": "button_type",
          "label": "Type",
          "options": [
            { "value": "primary", "label": "Primary" },
            { "value": "outline", "label": "Outline" },
            { "value": "link", "label": "Link" }
          ],
          "default": "primary"
        },
        {
          "type": "range",
          "id": "spacing_bottom",
          "label": "Spacing bottom",
          "min": 0,
          "max": 30,
          "step": 1,
          "default": 10,
          "unit": "px"
        }
      ]
    },
    {
      "type": "product",
      "name": "Product",
      "limit": 1,
      "settings": [
        { "type": "product", "id": "product", "label": "Product" },
        {
          "type": "range",
          "id": "spacing_bottom",
          "label": "Spacing bottom",
          "min": 0,
          "max": 30,
          "step": 1,
          "default": 10,
          "unit": "px"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Comparison",
      "blocks": [{ "type": "heading" }, { "type": "description" }, { "type": "button" }, { "type": "product" }]
    }
  ]
}
{% endschema %}
